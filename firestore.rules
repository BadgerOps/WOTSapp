rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isUniformAdmin() {
      return isAuthenticated() &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'uniform_admin' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    function isCandidateLeadership() {
      return isAuthenticated() &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'candidate_leadership' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // Users collection
    match /users/{userId} {
      // Users can read their own document
      allow read: if isOwner(userId);
      // Users can create their own document (on first login)
      allow create: if isOwner(userId);
      // Users can update their own document (except role)
      allow update: if isOwner(userId) &&
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']));
      // Admins can read all users and update roles
      allow read, update: if isAdmin();
    }

    // Posts collection
    match /posts/{postId} {
      // Anyone authenticated can read published posts
      allow read: if isAuthenticated() && resource.data.status == 'published';
      // Admins can read all posts (including drafts)
      allow read: if isAdmin();
      // Only admins can create, update, delete posts
      allow create, update, delete: if isAdmin();
    }

    // Documents collection
    match /documents/{documentId} {
      // Anyone authenticated can read documents
      allow read: if isAuthenticated();
      // Only admins can create, update, delete documents
      allow create, update, delete: if isAdmin();
    }

    // Uniforms collection
    match /uniforms/{uniformId} {
      // Anyone authenticated can read uniforms
      allow read: if isAuthenticated();
      // Only admins can create, update, delete uniforms
      allow create, update, delete: if isAdmin();
    }

    // Settings collection (for UOTD schedule, etc.)
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow create, update: if isAdmin();
      allow delete: if false;
    }

    // App Config settings - admins can manage
    match /settings/appConfig {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Weather Location settings - uniform admins can manage
    match /settings/weatherLocation {
      allow read: if isAuthenticated();
      allow write: if isUniformAdmin();
    }

    // Weather Rules settings - uniform admins can manage
    match /settings/weatherRules {
      allow read: if isAuthenticated();
      allow write: if isUniformAdmin();
    }

    // Weather Cache - read-only for clients, written by Cloud Functions
    match /settings/weatherCache {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // Weather Recommendations collection
    match /weatherRecommendations/{id} {
      // Uniform admins can read and update (approve/reject)
      allow read, update: if isUniformAdmin();
      // Only Cloud Functions can create/delete
      allow create, delete: if false;
    }

    // Personnel collection
    match /personnel/{personnelId} {
      // Anyone authenticated can read personnel
      allow read: if isAuthenticated();
      // Users can update their own personnel record (only phoneNumber, roomNumber, updatedAt)
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['phoneNumber', 'roomNumber', 'updatedAt']);
      // Admins can create, update, delete personnel
      allow create, update, delete: if isAdmin();
    }

    // Personnel Imports collection (tracks import history)
    match /personnelImports/{importId} {
      // Only admins can read and write import records
      allow read, create: if isAdmin();
      // No updates or deletes needed
      allow update, delete: if false;
    }

    // Detail Templates collection
    match /detailTemplates/{templateId} {
      // Anyone authenticated can read templates
      allow read: if isAuthenticated();
      // Only admins can create, update, delete templates
      allow create, update, delete: if isAdmin();
    }

    // Detail Assignments collection
    match /detailAssignments/{assignmentId} {
      // Anyone authenticated can read assignments
      allow read: if isAuthenticated();
      // Admins can do everything
      allow create, update, delete: if isAdmin();
      // Users can create their own self-assignments
      allow create: if isAuthenticated() &&
        request.resource.data.assignedTo.size() > 0 &&
        request.resource.data.assignedTo[0].personnelId == request.auth.uid;
      // Assigned users can update their assignments (start, complete tasks, submit, self-assign/unassign)
      // This allows status changes, task completion updates, and task claiming
      allow update: if isAuthenticated() &&
        // Only allow specific status transitions for non-admins
        (
          // Self-assign/unassign: assigned stays assigned (users can claim tasks)
          (resource.data.status == 'assigned' && request.resource.data.status == 'assigned') ||
          // Starting: assigned -> in_progress
          (resource.data.status == 'assigned' && request.resource.data.status == 'in_progress') ||
          // Task updates: in_progress stays in_progress (updating tasks, self-assign/unassign)
          (resource.data.status == 'in_progress' && request.resource.data.status == 'in_progress') ||
          // Submitting: in_progress -> completed
          (resource.data.status == 'in_progress' && request.resource.data.status == 'completed') ||
          // Re-doing after rejection: rejected -> in_progress
          (resource.data.status == 'rejected' && request.resource.data.status == 'in_progress') ||
          // Self-assign/unassign after rejection: rejected stays rejected
          (resource.data.status == 'rejected' && request.resource.data.status == 'rejected')
        );
    }

    // Detail Completions collection
    match /detailCompletions/{completionId} {
      // Anyone authenticated can read completions
      allow read: if isAuthenticated();
      // Users can create their own completion records
      allow create: if isAuthenticated() &&
        request.resource.data.personnelId == request.auth.uid;
      // Users can update their own completions, admins can update any
      allow update: if isAuthenticated() &&
        (resource.data.personnelId == request.auth.uid || isAdmin());
      // Only admins can delete completions
      allow delete: if isAdmin();
    }

    // Detail Config collection
    match /detailConfig/{configId} {
      // Anyone authenticated can read config
      allow read: if isAuthenticated();
      // Only admins can write config
      allow write: if isAdmin();
    }

    // Personnel Config collection (flights, classes)
    match /personnelConfig/{configId} {
      // Anyone authenticated can read config
      allow read: if isAuthenticated();
      // Only admins can write config
      allow write: if isAdmin();
    }

    // CQ Shifts collection
    match /cqShifts/{shiftId} {
      // Anyone authenticated can read shifts
      allow read: if isAuthenticated();
      // Candidate leadership and admins can manage shifts
      allow write: if isCandidateLeadership();
    }

    // CQ Schedule collection (new format with dual shifts)
    match /cqSchedule/{scheduleId} {
      // Anyone authenticated can read schedule
      allow read: if isAuthenticated();
      // Candidate leadership can update (edit assignments)
      allow update: if isCandidateLeadership();
      // Only admins can create or delete schedule entries
      allow create, delete: if isAdmin();
    }

    // CQ Roster collection (legacy roster-based scheduling)
    match /cqRoster/{rosterId} {
      // Anyone authenticated can read roster
      allow read: if isAuthenticated();
      // Only admins can manage roster
      allow write: if isAdmin();
    }

    // CQ Skips collection (dates to skip in schedule)
    match /cqSkips/{skipId} {
      // Anyone authenticated can read skips
      allow read: if isAuthenticated();
      // Only admins can manage skips
      allow write: if isAdmin();
    }

    // CQ Swap Requests collection (user-proposed shift swaps)
    match /cqSwapRequests/{requestId} {
      // Users can read their own requests
      allow read: if isAuthenticated() &&
        resource.data.requesterId == request.auth.uid;
      // Candidate leadership and admins can read all requests
      allow read: if isCandidateLeadership();
      // Authenticated users can create their own requests
      allow create: if isAuthenticated() &&
        request.resource.data.requesterId == request.auth.uid;
      // Users can cancel their own pending requests
      allow update: if isAuthenticated() &&
        resource.data.requesterId == request.auth.uid &&
        resource.data.status == 'pending' &&
        request.resource.data.status == 'cancelled';
      // Candidate leadership can update (approve/reject)
      allow update: if isCandidateLeadership();
      // Only admins can delete
      allow delete: if isAdmin();
    }

    // Pass Approval Requests collection
    match /passApprovalRequests/{requestId} {
      // Anyone authenticated can read their own requests
      allow read: if isAuthenticated() &&
        resource.data.requesterId == request.auth.uid;
      // Candidate leadership and admins can read all requests
      allow read: if isCandidateLeadership();
      // Authenticated users can create their own requests
      allow create: if isAuthenticated() &&
        request.resource.data.requesterId == request.auth.uid;
      // Candidate leadership can update (approve/reject)
      allow update: if isCandidateLeadership();
      // Only admins can delete
      allow delete: if isAdmin();
    }

    // Personnel Status collection (rolling current status)
    match /personnelStatus/{statusId} {
      // Users can read and update their own status (for self sign-out)
      allow read, write: if isOwner(statusId);
      // Allow authenticated users to write status for group operations (sign-out, sign-in, stage updates)
      allow write: if isAuthenticated() &&
        request.resource.data.updatedBy == request.auth.uid &&
        (request.resource.data.groupSignOut == true ||
         request.resource.data.groupSignIn == true ||
         request.resource.data.groupUpdate == true);
      // Candidate leadership and admins can read and write all
      allow read, write: if isCandidateLeadership();
      // Anyone authenticated can read all status (for status display)
      allow read: if isAuthenticated();
    }

    // Personnel Status History collection
    match /personnelStatusHistory/{logId} {
      // Candidate leadership and admins can read all history
      allow read: if isCandidateLeadership();
      // Candidate leadership and admins can create history entries
      allow create: if isCandidateLeadership();
      // Users can create their own history entries (for self sign-out)
      allow create: if isAuthenticated() &&
        request.resource.data.personnelId == request.auth.uid &&
        request.resource.data.selfUpdated == true;
      // Users can create history entries for group operations (sign-out, sign-in, stage updates)
      allow create: if isAuthenticated() &&
        request.resource.data.updatedBy == request.auth.uid &&
        (request.resource.data.groupSignOut == true ||
         request.resource.data.groupSignIn == true ||
         request.resource.data.groupUpdate == true);
      // No updates or deletes allowed
      allow update, delete: if false;
    }

    // CQ Notes collection
    match /cqNotes/{noteId} {
      allow read, write: if isCandidateLeadership();
    }

    // DA Forms collection (generated server-side)
    match /daForms/{formId} {
      allow read: if isAdmin();
      allow create, update, delete: if false;
    }

    // Password Resets collection (temporary passwords for new accounts)
    match /passwordResets/{userId} {
      // Only admins can read temporary passwords
      allow read: if isAdmin();
      // Only Cloud Functions can create/update password resets
      allow create, update: if false;
      // Admins can mark as used or delete
      allow delete: if isAdmin();
    }

    // Surveys collection
    match /surveys/{surveyId} {
      // Read: user is admin, OR user created it, OR it's published
      allow read: if isAuthenticated() &&
        (isAdmin() ||
         resource.data.createdBy == request.auth.uid ||
         resource.data.status == 'published');
      // Anyone authenticated can create surveys
      allow create: if isAuthenticated();
      // Creators can update their own surveys, admins can update any
      allow update: if isAuthenticated() &&
        (resource.data.createdBy == request.auth.uid || isAdmin());
      // Creators can delete their own surveys, admins can delete any
      allow delete: if isAuthenticated() &&
        (resource.data.createdBy == request.auth.uid || isAdmin());
    }

    // Survey Responses collection
    match /surveyResponses/{responseId} {
      // Anyone authenticated can read responses (for results viewing)
      allow read: if isAuthenticated();
      // Anyone authenticated can create a response
      allow create: if isAuthenticated();
      // Users can update their own responses
      allow update: if isAuthenticated() &&
        (resource.data.respondentId == request.auth.uid || isAdmin());
      // Admins can delete responses
      allow delete: if isAdmin();
    }
  }
}
